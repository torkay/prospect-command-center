---
phase: 01-production-hardening
plan: 01
type: execute
---

<objective>
Fix critical security issues blocking beta launch: JWT secret validation, Stripe env validation, missing module import.

Purpose: Ensure production deployment fails fast on misconfiguration rather than running with insecure defaults.
Output: Application that refuses to start without proper security configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md

**Source files to modify:**
@prospect/web/auth.py
@prospect/web/api/v1/billing.py
@prospect/web/api/v1/router.py
@.env.example

**Known issues from CONCERNS.md:**
- Weak JWT secret fallback at auth.py:17 - uses "dev-secret-key-change-in-production"
- Hardcoded Stripe price ID defaults at billing.py:25-29 - uses placeholder IDs
- Missing onboarding.py module imported at router.py:5
- Incomplete .env.example missing JWT_SECRET_KEY, STRIPE_*, APP_URL

**Constraints from PROJECT.md:**
- Stack: Python 3.11, FastAPI, SQLAlchemy
- No framework migrations - vanilla fixes only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add startup validation for security-critical environment variables</name>
  <files>prospect/web/auth.py, prospect/web/api/v1/billing.py</files>
  <action>
**In auth.py:**
Replace the weak fallback at line 17:
```python
SECRET_KEY = os.environ.get("JWT_SECRET_KEY", "dev-secret-key-change-in-production")
```
With validation that fails in production:
```python
SECRET_KEY = os.environ.get("JWT_SECRET_KEY")
if not SECRET_KEY:
    import sys
    # Allow missing secret only in development (check for common dev indicators)
    if os.environ.get("RAILWAY_ENVIRONMENT") or os.environ.get("PRODUCTION"):
        print("FATAL: JWT_SECRET_KEY environment variable is required in production", file=sys.stderr)
        sys.exit(1)
    # Development fallback with warning
    SECRET_KEY = "dev-secret-key-DO-NOT-USE-IN-PRODUCTION"
    import warnings
    warnings.warn("JWT_SECRET_KEY not set - using insecure development key")
```

**In billing.py:**
After line 22 (STRIPE_WEBHOOK_SECRET), add validation:
```python
# Validate required Stripe configuration at import time
def _validate_stripe_config():
    """Validate Stripe configuration at startup."""
    import sys

    if not stripe.api_key:
        if os.environ.get("RAILWAY_ENVIRONMENT") or os.environ.get("PRODUCTION"):
            print("FATAL: STRIPE_SECRET_KEY environment variable is required in production", file=sys.stderr)
            sys.exit(1)

    # Check for placeholder price IDs in production
    if os.environ.get("RAILWAY_ENVIRONMENT") or os.environ.get("PRODUCTION"):
        for tier, price_id in TIER_PRICES.items():
            if price_id.startswith("price_") and not price_id.startswith("price_1"):
                # Stripe price IDs start with "price_1", placeholders don't
                print(f"FATAL: STRIPE_PRICE_{tier.upper()} appears to be a placeholder: {price_id}", file=sys.stderr)
                sys.exit(1)

_validate_stripe_config()
```

**Why this approach:**
- Fail fast in production (RAILWAY_ENVIRONMENT or PRODUCTION env var)
- Allow development without env vars (dev convenience)
- Clear error messages that tell you exactly what to fix
- Validation runs at import time, not request time
  </action>
  <verify>
1. `python -c "import prospect.web.auth"` succeeds with warning about dev key
2. `PRODUCTION=1 python -c "import prospect.web.auth"` fails with clear error
3. `python -c "import prospect.web.api.v1.billing"` succeeds (no Stripe key needed in dev)
4. `PRODUCTION=1 python -c "import prospect.web.api.v1.billing"` fails if STRIPE_SECRET_KEY not set
  </verify>
  <done>
- auth.py validates JWT_SECRET_KEY, fails in production if missing
- billing.py validates STRIPE_SECRET_KEY and STRIPE_PRICE_* IDs, fails in production if misconfigured
- Development mode continues to work without env vars (with warnings)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create onboarding module stub and update .env.example</name>
  <files>prospect/web/api/v1/onboarding.py, .env.example</files>
  <action>
**Create prospect/web/api/v1/onboarding.py:**
```python
"""Onboarding API endpoints (stub for Phase 2 implementation)."""

from fastapi import APIRouter

router = APIRouter(prefix="/onboarding", tags=["onboarding"])


@router.get("/status")
def get_onboarding_status():
    """
    Get onboarding status for current user.

    Stub endpoint - full implementation in Phase 2 (Onboarding Experience).
    """
    return {
        "completed": False,
        "steps": {
            "welcome_seen": False,
            "first_search": False,
            "score_explained": False,
        },
        "message": "Onboarding flow coming soon",
    }
```

**Update .env.example** - add these sections after the existing content:

```
# -----------------------------------------------------------------------------
# REQUIRED (Production): Authentication
# -----------------------------------------------------------------------------
# Generate a strong secret: python -c "import secrets; print(secrets.token_hex(32))"
# JWT_SECRET_KEY=your-secret-key-here

# -----------------------------------------------------------------------------
# REQUIRED (Production): Stripe Billing
# -----------------------------------------------------------------------------
# Get keys from https://dashboard.stripe.com/apikeys
# STRIPE_SECRET_KEY=sk_test_...
# STRIPE_WEBHOOK_SECRET=whsec_...

# Price IDs from Stripe Dashboard (Products > Pricing)
# STRIPE_PRICE_SCOUT=price_1...      # $99/month Scout tier
# STRIPE_PRICE_HUNTER=price_1...     # $149/month Hunter tier
# STRIPE_PRICE_COMMAND=price_1...    # $499/month Command tier

# -----------------------------------------------------------------------------
# OPTIONAL: Application URL
# -----------------------------------------------------------------------------
# Used for billing portal return URLs
# APP_URL=https://your-app-url.com
```

**Why this approach:**
- Stub module prevents import error while Phase 2 is built
- Stub returns useful status structure (not just empty)
- .env.example documents all required production vars
- Comments include how to generate/find each value
  </action>
  <verify>
1. `python -c "from prospect.web.api.v1 import onboarding; print(onboarding.router)"` succeeds
2. `python -c "from prospect.web.api.v1.router import router; print(router)"` succeeds (full router imports)
3. .env.example contains JWT_SECRET_KEY, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_* vars
  </verify>
  <done>
- onboarding.py exists with stub /status endpoint
- router.py imports work without error
- .env.example documents all security-critical variables with generation instructions
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from prospect.web.app import create_app; print('OK')"` succeeds (full app imports)
- [ ] `PRODUCTION=1 python -c "import prospect.web.auth"` fails with JWT_SECRET_KEY error
- [ ] `PRODUCTION=1 STRIPE_SECRET_KEY=test python -c "import prospect.web.api.v1.billing"` fails with price ID error
- [ ] .env.example has all required production variables documented
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No import errors in application startup
- Production deployment would fail fast on missing security config
- .env.example is complete documentation for deployment
</success_criteria>

<output>
After completion, create `.planning/phases/01-production-hardening/01-01-SUMMARY.md`
</output>
